<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/JSXTransformer.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.6.1/lodash.min.js"></script>
    <style>
      * {
        padding: 0;
        margin: 0;
      }
      body {
        font-family: sans-serif;
        padding: 40px 20px;
        color: #555;
      }
      h3 {
        margin-bottom: 15px;
      }
      .row {
        padding: 10px 20px;
        background: #eee;
        margin-bottom: 10px;
      }
      .content {
        display: flex;
        width: 100%;
      }

      .col {
        margin: 0 20px;
        flex: 1;
      }
    </style>
  </head>
  <body>
  </body>



<script type="text/jsx">
"use strict";

const usersList = [{
  "id": "0001",
  "name": "Phil"
},{
  "id": "0002",
  "name": "Tully"
},{
  "id": "0003",
  "name": "Dom"
},{
  "id": "0004",
  "name": "Kelv"
}]

const eventsList = [{
  "id": "0001",
  "gameName": "Splendor",
  "players": ["0001", "0003"],
  "winner": "0003"
},{
  "id": "0002",
  "gameName": "Machi Koro",
  "players": ["0001", "0002", "0003"],
  "winner": "0002"
},{
  "id": "0003",
  "gameName": "Splendor",
  "players": ["0004", "0002", "0003", "0001"],
  "winner": "0002"
},{
  "id": "0004",
  "gameName": "Splendor",
  "players": ["0002", "0001"],
  "winner": "0001"
},{
  "id": "0005",
  "gameName": "Colt Express",
  "players": ["0002", "0001", "0004"],
  "winner": "0002"
},{
  "id": "0006",
  "gameName": "Colt Express",
  "players": ["0001", "0003", "0004"],
  "winner": "0003"
},{
  "id": "0007",
  "gameName": "Colt Express",
  "players": ["0001", "0003", "0004", "0002"],
  "winner": "0003"
}];



const Content = React.createClass({

  // Cross reference an event's winner id with all users to get the winner name
  renderWinner(event) {
    const winnerName = usersList.map(winner => {
      if (winner.id === event.winner) {
        return winner.name;
      }
    });
    return winnerName;
  },

  renderEventPlayers(event) {
    let eventPlayers = [];
    usersList.map(user => {
      if (event.players.includes(user.id)) {
        eventPlayers.push(user.name);
      }
    });
    return eventPlayers;
  },

  // Simply render all the events highlighting the winner
  renderEvents() {
    const events = eventsList.map(event => {
      const displayEventUsers = this.renderEventPlayers(event).map(player => {
        return `${player} `
      });
      return <div className="row">
        <div className="name">{event.id} {event.gameName} -  Winner: {this.renderWinner(event)}<br />
          {displayEventUsers}
        </div>
      </div>
    });
    return events
  },

  // Which events a user has won
  userWins(user) {
    let wins = [];
    eventsList.map(event => {
      if (event.winner === user.id) {
        wins.push(event.gameName);
      }
    });
    return wins;
  },

  // Which events a user has played
  userEvents(user) {
    let eventsPlayed = [];
    eventsList.map(event => {
      if (event.players.includes(user.id)) {
        eventsPlayed.push(event.gameName);
      }
    });
    return eventsPlayed;
  },

  // Get user's most successful event
  userBestEvent(user) {

    const list = this.userWins(user);

    const mostWins = list.reduce((a, b, i, array) => {
      let output = [];
      if (array[i] === array[i-1]) {
        output.push(array[i]);
      } else {
        output.push(array);
      }
      const flattened = output.reduce((a, b) => {
        return a.concat(b);
      }, []);

      return flattened;
    },[]);

    return _.isEmpty(mostWins) ? "no wins yet" : mostWins;


    // Original attempt with array like object
    // Create object of events and tally of times played
    // const counts = {};
    // for (var i = 0; i < this.userWins(user).length; i++) {
    //   var num = this.userWins(user)[i];
    //   counts[num] = counts[num] ? counts[num] + 1 : 1;
    // }

    // // Filter events to only show the most played (showing multiples if it's a tie)
    // const topEvents = counts;

    // // Get the name of the event(s)
    // const namedEvents = [];
    // Object.keys(topEvents).forEach(val => {
    //   namedEvents.push(val);
    // });


    // Attempt with Ethel
    // const counts = this.userWins(user).reduce((a, b, i, array) => {
    //   const find = _.find(a, ['name', array[i]]);
    //   if (find) {
    //     find.count += 1;
    //     return a;
    //   } else {
    //     return a.concat({name: array[i], count: 1})
    //   }
    // }, []);


  },

  // Calculate percentage win ratio of a user
  userWinRatio(user) {
    return Math.round(this.userWins(user).length / this.userEvents(user).length * 100 * 10) / 10;
  },

  // Render a user's stats
  renderUser(user) {
    return <div className="row">
      {user.name} - Won {this.userWins(user).length} of {this.userEvents(user).length} ({this.userWinRatio(user)}%)<br />
      Most wins: {this.userBestEvent(user)}
    </div>
  },

  // Render the users in order of users in descending order of win ratio
  renderLeaderboard() {
    const output = usersList.sort((a,b) => {
      return this.userWinRatio(b) - this.userWinRatio(a);
    }).map((user) => {
      return <div>
        {this.renderUser(user)}
      </div>
    })
    return output;
  },

  // Show me the money
  render() {

    return <div className="content">
      <div className="col">
      <h3>Events</h3>
      {this.renderEvents()}
      </div>
      <div className="col">
        <h3>Leaderboard</h3>
        {this.renderLeaderboard()}
      </div>
    </div>
  }

});





const element = React.createElement(Content);
React.render(element, document.body);
</script>
</html>
