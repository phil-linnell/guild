<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="../public/lib/JSXTransformer.js"></script>
    <script src="../public/lib/react.js"></script>
    <script src="../public/lib/lodash.min.js"></script>
    <script src="data/db.js"></script>
    <link rel="stylesheet" href="../public/stylesheets/styles.css">
  </head>
  <body>
  </body>



<script type="text/jsx">
"use strict";


const Content = React.createClass({

  // Cross reference an event's winner id with all users to get the winner name
  renderWinner(event) {
    const winnerName = usersList.map(winner => {
      if (winner.id === event.winner) {
        return winner.name;
      }
    });
    return winnerName;
  },

  renderEventPlayers(event) {
    let eventPlayers = [];
    usersList.map(user => {
      if (event.players.includes(user.id)) {
        eventPlayers.push(user.name);
      }
    });
    return eventPlayers;
  },

  // Simply render all the events highlighting the winner
  renderEvents() {
    const events = eventsList.map(event => {
      const displayEventUsers = this.renderEventPlayers(event).map(player => {
        return <li>
          {player}
        </li>
      });
      return <div className="row event-card">
        <div className="header">
          <div className="image"></div>
          <div className="info">
            <div className="id">{event.id}</div>
            <h2>{event.gameName}</h2>
            <div className="date">Date: </div>
          </div>
        </div>
        <h3>Players:</h3>
        <ul className="users">
          {displayEventUsers}
        </ul>
        <div className="winner">Winner: <span className="name">{this.renderWinner(event)}</span></div>
      </div>
    });
    return events
  },

  // Which events a user has won
  userWins(user) {
    let wins = [];
    eventsList.map(event => {
      if (event.winner === user.id) {
        wins.push(event.gameName);
      }
    });
    return wins;
  },

  // Which events a user has played
  userEvents(user) {
    let eventsPlayed = [];
    eventsList.map(event => {
      if (event.players.includes(user.id)) {
        eventsPlayed.push(event.gameName);
      }
    });
    return eventsPlayed;
  },

  userNemesis(user) {
    let didNotWin = [];
    eventsList.map(event => {
      if (event.players.includes(user.id) && (user.id != event.winner)) {
        didNotWin.push(event);
      }
    });

    const xs = didNotWin.map(val => {
      return val.winner;
    });

    const counts = xs.reduce((a, b, i, array) => {
      const find = _.find(a, ['winner', array[i]]);
      if (find) {
        find.count += 1;
        return a;
      } else {
        return a.concat({winner: array[i], count: 1})
      }
    }, []);

    const output = counts.reduce((acc,x) => {
      if (acc.length === 0) {
        acc.push(x)
      } else if (acc[0].count < x.count) {
        acc = [x];
      } else if (acc[0].count === x.count) {
        acc[0].count += 1;
      }
      return acc;
    }, [])

    console.log(output);

    const final = usersList.map(usr => {
      const d = output.map(d => {
        if (usr.id === d.winner) {
          return usr.name;
        }
      });
      return d;
    });

    return final;
  },

  // Get user's most successful event
  userBestEvent(user) {

    const list = this.userWins(user);

    const counts = list.reduce((a, b, i, array) => {
      const find = _.find(a, ['name', array[i]]);
      if (find) {
        find.count += 1;
        return a;
      } else {
        return a.concat({name: array[i], count: 1})
      }
    }, []);

    // const counts = list.reduce((acc,x,i) => {
    //   if (acc.length === 0) {
    //     acc.push({name: "", count: 0})
    //   }
    //   if (acc[i].name === x) {
    //     acc[i].count += 1;
    //   } else {
    //     acc.push({name: x, count: 1})
    //   }
    //   return acc;
    // }, []);

    const output = counts.reduce((acc,x) => {
      if (acc.length === 0) {
        acc.push(x)
      } else if (acc[0].count < x.count) {
        acc = [x];
      } else if (acc[0].count === x.count) {
        acc.push(x);
      }
      return acc;
    }, [])

    return output;
  },

  // Calculate percentage win ratio of a user
  userWinRatio(user) {
    return Math.round(this.userWins(user).length / this.userEvents(user).length * 100 * 10) / 10;
  },

  // Render a user's stats
  renderUser(user) {
    let games = this.userBestEvent(user).map(val => {
      return <span className="games">
        {val.name} <span className="count">({val.count})</span>
      </span>;
    });
    if (this.userBestEvent(user).length === 0) {
      games = "No wins yet"
    }
    // const nemesis = this.userNemesis(user).map(val => {
    //   return <span className="item">
    //     {val.id} <span className="count">({val.count})</span>
    //   </span>;
    // });
    return <div className="row user-card">
      <div className="info">
        <h2 className="name">{user.name}</h2>
        <div className="win-ratio">{this.userWinRatio(user)}%</div>
        <div className="wins">Won: {this.userWins(user).length} of {this.userEvents(user).length}</div>
        <div className="most-wins">Most wins in: {games}</div>
        <div className="nemesis">Nemesis: {this.userNemesis(user)}</div>
      </div>
    </div>
  },

  // Render the users in order of users in descending order of win ratio
  renderLeaderboard() {
    const output = usersList.sort((a,b) => {
      return this.userWinRatio(b) - this.userWinRatio(a);
    }).map((user) => {
      return <div>
        {this.renderUser(user)}
      </div>
    })
    return output;
  },

  // Show me the money
  render() {
    return <div className="content">
      <div className="col">
        {this.renderEvents()}
      </div>
      <div className="col">
        {this.renderLeaderboard()}
      </div>
    </div>
  }

});





const element = React.createElement(Content);
React.render(element, document.body);
</script>
</html>
